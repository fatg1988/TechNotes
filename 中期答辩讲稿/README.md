基于PaaS的容器引擎管理平台的设计及实现
========================

开场：各位老师上午好，我论文的课题是《基于PaaS的容器引擎管理平台的设计及实现》，下面我给老师们介绍下论文中期的情况。我将从下面五个部分对论文中期工作进行阐述。

#### 目录
--------

第一部分，我将介绍一下我的项目的背景与意义，交代一下论文的背景情况；

第二部分，将介绍一下论文当前的工作进展，以及主要的模块划分和架构设计；

第三部分，主要介绍论文取得的阶段性成果，各个主要模块的完成情况和达到效果；

第四部分，介绍在项目开发的过程中遇到的问题，以及相关问题对应的解决方案；

第五部分，介绍一下下一步论文的工作计划；


#### 项目背景与意义
--------

* 项目背景

随着互联网的蓬勃发展，新技术不断涌现，业务场景越来越复杂多样，业务的快速变化需要产品开发也要同步的快速迭代，快速发布，这给传统的运维方式提出了挑战。传统的运维手段还停留在手工部署、手工运维的阶段，多个部署环境甚至不同的机器都有各自独特的配置信息，这些信息有不同的人员负责，整个运维体系信息不够清晰，运维人员的权责也不够分明，运维的成本很高。传统的运维方式的另一个问题是自动化程度低，人为故障率搞，部署流程冗长，产品不能快速发布到线上，造成业务没有竞争力。


* 项目意义

基于PaaS的容器引擎管理平台，主要意义在于它打通了整个部署的流水线，实现了持续集成和持续发布，开发人员提交代码后，代码检查，依赖包检查，安全检查，自动化测试，自动化集成测试等整个过程都自动完成，多个开发项目可以互不影响的推进，每个项目能够做到每天至少一次的发布；PaaS容器引擎平台大大降低了运维的成本，成本分为两个方面，一个是硬件方面，使用容器引擎后，物理机的数量减少到之前的一半以下；另一个方面是人工成本，以前一个应用的上线时间大概在半个小时到一个小时之间，现在只需一分钟。容器引擎提供的实施健康检查，可以让应用自动恢复，实时保证应用可用的实例数，无需生产运维人员时刻关注应用的运行情况，大大降低了运维人员的心智负担。容器云提供了多方面的高可用的保证，也提供了多维度的监控方案，容器引擎的监控的目标是实现无人值守的监控，即：我们无需监控人员日夜关注系统的运行情况，只有收到报警时才进行干预。容器引擎还做到了秒级的水平扩容，运维人员可以通过平台轻松实现应用的水平扩容，扩容的操作能在10秒内结束。


#### 论文完成情况
---------

* 论文进度

迄今为止，我的论文工作完成以下内容：系统需求分析、架构设计、数据库设计、功能设计现已全部完成，核心模块的开发也完成了80%，另外系统测试也已经开始了，完成了40%的测试工作。

* 架构设计

这张图是容器引擎平台的架构图，从大的方面看，他主要分为三个层次，最上层是Web展示层，它是与用户沟通的媒介，用户主要是开发人员和运维人员，用户可以通过它轻松完成应用的发布和回滚；中间层是缓存层，我们使用了Redis主从集群实现的缓存，它主要缓存了用户的登录数据和应用的数据，主要是为了实现前端应用的无状态以及用户能够快速得到响应；最下面的一层是数据持久层，它主要分为两个部分：Kubernetes集群和MySQL集群，Kubernetes集群负责应用的调度和编排，MySQL负责将Kubernetes集群元数据、操作记录等进行持久化。

* 数据库设计

下面这张图是我们容器引擎平台的数据库E-R图，我们的设计思路是以组织为中心，组织在我们这里代表着预算的单位，我们为每个预算单位（二级部门）分配计算资源的配额，他们根据需要进行购买，他们可以选择将应用同时部署到多个数据中心，实现应用的多活；用户是在某个组织下面，即某个部门的员工只能操作自己部门的应用；应用发布是整个容器引擎工作的核心，它负责应用的整个生命周期管理：上线、升级、回滚、下线、扩容/缩容等。为了方便使用，我们还提供了发布模板的功能，用户可以将发布操作保存模板，后面的发布可以直接使用已保存的模板快速进行发布。

* 功能结构设计

这张图是容器引擎的功能结构设计，功能从上到下可以看做一个树形结构，容器引擎平台从功能上分为应用管理、服务管理、代码管理、镜像管理、用户管理和监控等六个大部分。其中应用发布是整个功能的中心，它主要负责应用的生命周期管理，功能设计也是根据生命周期管理进行设计，包括应用发布、应用历史、滚动升级、回滚、扩容和删除应用等几个部分；服务管理是将已经发布的应用对外发布并对请求进行负载均衡，包括创建服务、创建访问点、查看服务等功能；代码管理是容器引擎平台的第二个重点，它涵盖整个持续发布的过程，代码管理涉及从代码提交到自动化测试到镜像构建，再到将应用发布到容器引擎中整个过程，这个过程也是从开发到运维的过程，它关系到开发人员与运维人员沟通的效率，直接制约着代码的质量和发布的速度。镜像管理和用户管理相对简单，镜像管理主要对镜像进行管理，例如镜像的搜索、查看、删除和镜像同步等，用户管理主要涉及用户的权限管理和账号分配，如创建/注销用户、权限管理等；监控部分主要涉及计算节点的监控和集群拓扑图的监控，这块使用成熟的开源组件实现，我们只需将监控的结果集成到我们的平台上即可。


#### 阶段性成果
-------------

* 代码管理模块概述

接下来给老师们介绍一下我论文工作的阶段性成果，我主要介绍代码管理模块、镜像管理模块、应用管理模块和监控模块。

对于代码管理模块，就像前面提到的，它主要完成持续集成的工作，其中包括几个主要的部分：代码管理，包括版本控制和代码Review，自动触发构建，我们的策略是在代码主干合并时自动触发构建过程，在构建过程中，我们要遵循一个原则，就是我们只进行一次构建，多个环境使用同一套镜像进行部署，保证不同的环境的运行时的一致性；打通代码的流水线的同时，也让开发人员跟运维人员能够更有效的沟通；自动化测试可以有效保证代码的质量，测试后的应用自动构建成Docker镜像，代码管理模块会将它自动的部署到QA环境中。整个代码管理模块实现了构建的自动化，这就可以实现了每天多次构建，而且构建的过程会实时推送给用户，用户可以实时看到自己应用的构建结果。


* 代码管理模示意图

这张图是代码管理模块的示意图，它展示了整个持续交付的过程：从开发人员提交代码到版本管理仓库后，开发组长进行代码Review，通过后将代码合并到主干，主干合并自动触发构建过程，构建过程开始，Jenkins收到构建指令，将对应任务的代码拉取到本地，一次进行编译、单元测试、代码安全检查、依赖库检查、集成测试、打包和构建镜像，最后将镜像推送到镜像仓库，整个构建过程会在页面上进行显示，用户可以实时观察构建过程的输出。接下来就是各个环境部署了，先将构建的镜像发布到测试环境，测试人员测试通过后，依次发布到准生产、生产环境。

* 代码管理模块的流程图

这是代码管理的流程图，从开发人员提交代码开始，依次经过Git代码仓库、Jenkins构建、编译、单元测试、打包、构建镜像、推送镜像仓库、发布到测试环境等过程，这其中任一环节出了问题，整个过程将终止，并将出错的原因以邮件的方式发送给用户。

* 镜像管理模块概述

镜像管理模块的功能主要包括：多个可信私有仓库的搭建，要支持镜像的搜索、查看、删除等操作，还要支持镜像的推送、拉取、复制等功能，这些功能的实现有几个难点，镜像一般都在200~500MB左右，多个环境之间进行镜像同步对网络带宽有一定的压力，基础镜像一般在200~300MB，应用的镜像会在这个基础上多个100~200MB，跨多个网络传输有速率的限制还有带宽的压力，另外，镜像的访问控制也是个难点，即镜像的可见性和权限问题。

* 镜像管理模块

上面这张图是容器引擎与私有镜像仓库交互的过程，他们之间通过RESTful API接口进行交互，私有镜像仓库实现了镜像的存储和发现。

* 应用管理模块

应用管理模块主要实现了应用的全生命周期管理：应用的上线，可以从模板导入，实现一键上线；应用的滚动升级，用户可控的升级过程，整个升级过程服务不停机；应用回滚，实现应用的一键回滚，而且能够回滚到最近的10个版本；应用下线，用户使用容器引擎平台可以实现应用的一键下线；弹性扩容实现了秒级的扩容、缩容，扩容缩容的操作由手工完成，实例数要求每个集群中最少1个，最多10个实例；降低成本也是应用管理模块的任务之一，计算资源要比虚拟机节约2~10倍，时间成本从小时级降至秒级，人力成本和工作效率提升是成本节约的重点，从多人配合操作到一个人一键操作；让操作无风险，任何操作都可以快速的进行回滚，无操作风险，避免了人为的操作事故。

* 应用管理模块时序图

上面的图展示了容器引擎平台如何与Kubernetes集群进行交互，他们之间也是通过RESTful接口进行交互，数据以JSON格式进行交互。

下面的图是应用发布的时序图，它展示了用户的应用发布操作在容器引擎平台中是如何工作的，用户进行应用发布后，容器引擎平台的Web端会给后台一个Post请求，后台收到请求后会进行一些验证操作，然后它会给Kubernetes的API操作
