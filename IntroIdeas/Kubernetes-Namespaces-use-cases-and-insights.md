##Kubernetes 命名空间：用例和洞见
------------------------------

```
谁在一垒？什么是二垒？三垒我不知道。

--《谁在一垒》 by Abbott and Costello
```
（译者注：《谁在一垒》是美国相声界的经典作品。用在此处为了说明命名的重要性。）


###简介
-------------------

Kubernetes中的很多概念都可以清晰地表示为RESTful API中的“对象”（也称作“资源”或“类型”）。其中[命名空间](http://kubernetes.io/docs/user-guide/namespaces/)（Namespace)可以用来将一个Kubernetes集群划分为多个虚拟集群。本文将讲述几个如何使用命名空间的例子。

开始之前，先简单比喻一下命名空间。命名空间就像我们的姓氏，例如“王“，它代表着一个家族单元。在“王氏”家族内有个成员，比如“王森”，族人会把他称为“森”。但是在家族之外，可能会有别的“森”。为了避免“到底是哪个森”的问题，前面的“森“经常需要说明自己是“王森”，甚至还得说明是“来自北京的王森”。

命名空间提供了逻辑上的划分。它可以使一个Kubernetes集群被多个用户、一组用户或者一个用户的多个应用所使用，而不用多余的交流。每个用户、每组用户、或者每个应用存在于它的命名空间里，而与其他的集群用户隔离开来，就像只有他们在使用一样（补充：通过[资源配额](http://kubernetes.io/docs/admin/resourcequota/)--Resources Quotas可以把Kubernetes的一部分资源分配给命名空间）。

不管你怎么使用Kubernetes，即使场景很小，你也会因为使用了命名空间而获益。本文里我们将讲述谷歌云平台（GCP, Google Cloud Platform)的用户使用命名空间的常见方法，同时也期待学习各位读者的使用例子。


这些用例涵盖了：
    1. 企业中命名空间的角色和责任
	2. 划分版图：开发 vs 测试 vs 生产
	3. 在非多租户场景里划分客户
	4. 什么时候不使用命名空间


###用例1： 企业里的角色和责任
-------------------------------

一个典型的企业包含了多个业务/技术实体，它们相互独立运作，企业通过一些上层的整体控制进行管理。清晰定义了Kubernetes的角色和责任，会使得对集群的运维变得简单和高效。

下面推荐一些可以简化在大型组织里管理Kubernetes集群的角色和相应的责任。

	1. 设计者/架构者角色：这个角色将产品、定位、团队和成本中心都纳入考虑，定义了全局的命名空间策略，并决定如何最好地将这些映射为Kubernetes命名空间。采用这样的角色可以防止命名空间的激增和“雪花”状命名空间。

	2. 管理员角色：这个角色拥有管理所有Kubernetes集群的权力，他可以创建、删除集群，或者通过添加、移除节点来对集群进行扩展。这个角色负责修补、安全和维护这些集群。Kubernetes管理员负责实现由设计者/架构者定义的命名空间策略，以及实现在组织内不同实体间的配额管理。

这两个角色和实际使用集群的开发者都会收到来自企业安全和网络团队关于例如安全隔离需求和命名空间如何适配这个模型等问题的支持和反馈，或者帮助网络子网和负载均衡器进行设置。

反模式：

	1. 不借助中心化控制的Kubernetes使用会成为孤岛：如果不在开始时围绕Kubernetes的管理建立一个中心化控制结构，那么很有可能会因为“[蘑菇农场]”拓扑而终止。即没有定义组织内集群的大小、形状和结构。最终的结果是由于资源利用不足带来的高风险和高成本，并且变得难以管理。

	2. 旧时代IT的控制遏制了新方法的使用：一个大趋势是试着调换已有的控制/过程为新的动态框架，这将影响这些框架敏捷本质，并且失去了快速动态开发的好处。
	
	3. 全方位集群：对于创建命名空间管理结构/技术的耽误，会带来一个很大的全方位集群，而它很难再被划分为更小的使用组了。

	
###用例2：使用命名空间划分开发版图
---------------------------------

软件开发团队通常将他们的开发过程划分为分离的单元。这些单元形式各异，并且使用不同的标签，但会导致分裂的开发环境：一个测试/QA环境、可能有一个分期的环境、甚至一个最终的生产环境。结果的布局非常契合于Kubernetes的命名空间，开发过程中的每个环境或阶段都可以成为唯一的命名空间。

上面的工作中每个命名空间都可以被模板化和镜像为开发环中下一阶段的环境，例如：开发->QA->生产。每个命名空间逻辑分离的特点，允许开发团队在一个隔离的“开发”命名空间里工作。DevOps（在谷歌最接近的角色是[Site Reliability Engineering](https://landing.google.com/sre/interview/ben-treynor.html)——SRE）负责按照开发过程合并代码，并且保证每个团队被分配到合适的环境里。最后，DevOps将对最后用于交付用户解决方案的生产环境完全负责。

给开发周期应用命名空间的一大好处是软件组件的命名（例如：微服务/访问点）：在不同的环境里使用相同的名字而不会发生冲突。这源自Kubernetes命名空间的隔离性。例如开发环境里的服务X可能会被跨命名空间引用，如果有必要，可以按照它在mycluster.com的开发命名空间里的全称域名serviceX.development.mycluster.com来进行唯一引用。


反模式：
	
	1. 滥用命名空间会给开发过程带来不必要的环境。所以，如果不需要分阶段开发，不要创建“staging”命名空间。

	2. 过度拥挤的命名空间，例如你所有的开发项目都放在一个巨大的“development”命名空间里。因为命名空间就是为了进行划分，那么也可以使用项目来划分命名空间。因为命名空间是扁平的，你可能希望这样：projectA-dev，projectA-prod等作为项目A的命名空间。


###用例3：划分你的客户
-----------------------

例如你是一个希望为你的每个客户管理独立应用的咨询公司，借助于命名空间进行划分会比较一致。你可以为每个客户、客户项目或客户业务单元创建一个命名空间来保证清晰性，同时不需要担心跨项目的资源名称被重用。

一个重要的顾虑是：Kubernetes目前还没有提供加强跨命名空间访问控制的技术，所以我们建议读者不要将以这种方式开发的应用对外暴露。


反模式：

	1. 因为应用已经加强了这个划分，多租户应用不需要额外的Kubernetes命名空间来增加复杂性。

	2. 用户与命名空间映射的不一致。例如：你在一个全球企业里赢得了业务，你可能会考虑为这个企业建立一个命名空间，而不考虑这个客户更愿意长远的划分。例如，BigCorp公司有两个部门，Accounting和Engineering，那么在这个例子里，每个部门的客户都会希望有一个自己的命名空间。


###何时不用命名空间?
-------------------------

在一些情形下，Kubernetes命名空间不能提供你需要的所有隔离。这可能是因为地理原因、账务或安全因素。对于命名空间逻辑划分能带来的所有好处，目前没有别的技术能加强这个划分。一个Kubernetes集群里的任何用户或资源都可以在无视命名空间的情况下访问集群里的其他资源。所以，如果你需要保护或者隔离资源，最终的解决方案是：对独立的Kubernetes集群执行你的常规安全/ACL控制。

其他时候，当你希望反映地理分布部署而不准备使用命名空间时，例如你希望部署得离美国、欧洲和亚洲用户更近一点，推荐你在每个区域里本地部署一套Kubernetes集群。

可能因为成本中心或者客户拒付，你需要细粒度的账务信息，推荐将收费的事情交给基础设施提供商。例如，在GCP，你可使用独立的GCP[项目](https://cloud.google.com/compute/docs/projects)或者[付款账户](https://support.google.com/cloud/answer/6288653)，并且部署一套Kubernetes集群到一个特定客户的项目里。

在需要保密或者用户之间的完全不透明的场景里，每个客户/工作负载使用一个Kubernetes集群可以提供这个级别的隔离。再一次说明，你应该讲资源的划分委托给你的提供商。

为了提供Kubernetes命名空间ACL以加强安全性和提供Kubernetes[集群联邦](http://blog.kubernetes.io/2016/07/cross-cluster-services.html)的工作正在进行。这两种技术都强调了这些反模式里使用独立Kubernetes集群的原因

一个易于理解Kubernetes命名空间的反模式是版本。你不应该使用命名空间来区分Kubernetes资源的不同版本。对于版本的支持，应该由容器和容器仓库或Kubernetes的Deployment资源来完成。Kubernetes容器模型还通过Deployments提供了版本间的自动迁移，所以多个版本是可以共存的。而且单集群里的版本级命名空间会增长得非常大，并且变得难以管理。


###“老司机”警告
----------------------------------------

你可能会希望，但是你不能创建一个命名空间层级。命名空间不能一个嵌套一个。你不能创建，例如my-team.my-org这样的命名空间，但是可以创建team-org。

命名空间易于创建和使用，但也很容易将代码部署到错误的命名空间里。保持一个良好的DevOps习惯，例如将可能的步骤都文档化和自动化，这会很有用。限制使用命名空间的其他方法就是[kubectl context](http://kubernetes.io/docs/user-guide/kubectl/kubectl_config_set-context/)了。

就像之前提到的，Kubernetes目前并不提供加强跨命名空间安全的技术。你只能在可信域名（例如内网）里使用命名空间。而当你需要保证Kubernetes集群的一个用户或他的资源不能被其他命名空间资源访问的时候，你不要使用命名空间。在Kubernetes的授权和认证兴趣小组里对这些增强安全性的方法都进行了讨论，点击这里参与[SIG-Auth](http://kubernetes.io/docs/user-guide/kubectl/kubectl_config_set-context/).


##译者说
-------------
为了便于理解，本文的例子略有改动

命名空间算是计算机系统中一个十分重要的概念：文件系统给文件赋予名字、编程语言通过命名空间来组织变量和子程序等。在一个命名空间内，名称不能有二义。

Docker通过Linux内核的Namespace机制完成了资源的隔离，包括：

| Namespace | 系统调用参数  | 隔离内容 |
|:---------:|:-----------:|:-------:|
| UTS       | CLONE_NEWUTS | 主机名与域名 |
| IPC       | CLONE_NEWIPC | 信号量、消息队列和共享内存 |
| PID       | CLONE_NEWPID | 进程号 |
| Network   | CLONE_NEWNET | 网络设备、网络栈、端口等 |
| Mount     | CLONE_NEWNS  | 挂载点（文件系统） |
| User      | CLONE_NEWUSER| 用户和用户组 |

Kubnernetes通过kubectl get ns查看集群现有的命名空间，通过kubectl create ns "名称"来创建新的命名空间。具体的类型定义戳[这里](https://godoc.org/k8s.io/kubernetes/pkg/api#Namespace)。



##作者及原文链接
----------------------
Mike Altarace & Daz Wilkin, Strategic Customer Engineers, Google Cloud Platform

[Kubernetes Namespaces: use cases and insights](http://blog.kubernetes.io/2016/08/kubernetes-namespaces-use-cases-insights.html)
